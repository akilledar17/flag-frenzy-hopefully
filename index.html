<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flag Frenzy</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f2f2f2;
      text-align: center;
      transition: background 0.3s, color 0.3s;
    }

    body.dark {
      background: #1e1e1e;
      color: white;
    }

    h1 {
      margin-top: 100px;
    }

    #game, #pause, #wrong, #regionSelectScreen, #endlessResults {
      display: none;
    }

    .button {
      background: #007bff;
      color: white;
      border: none;
      padding: 14px 24px;
      margin: 10px auto;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      width: 80%;
      max-width: 300px;
      display: block;
      transition: background 0.3s ease;
    }

    .button:hover {
      background: #0056b3;
    }

    .button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    img {
      margin: 10px auto;
      max-width: 120px;
      height: auto;
      display: block;
      border: none;
    }

    .timer {
      font-size: 18px;
      margin: 10px;
    }

    #pauseBtn, #darkModeBtn {
      position: absolute;
      top: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    #pauseBtn:hover, #darkModeBtn:hover {
      color: #007bff;
    }

    #pauseBtn {
      right: 50px;
    }

    #darkModeBtn {
      right: 10px;
    }

    #incorrectList {
      max-height: 200px;
      overflow-y: auto;
      text-align: left;
      margin: 10px auto;
      width: 80%;
      max-width: 300px;
    }
  </style>
</head>
<body>

  <button id="pauseBtn" onclick="pauseGame()">‚è∏Ô∏è</button>
  <button id="darkModeBtn" onclick="toggleDarkMode()">üåë</button>

  <h1>üåç FLAG FRENZY</h1>

  <!-- Main Menu -->
  <div id="menu">
    <p>High Score (<span id="regionLabel">All Regions</span>): <span id="highScore">0</span></p>
    <button class="button" id="playButton" onclick="startGame()" disabled>Play (All Regions)</button>
    <button class="button" id="endlessButton" onclick="startEndlessMode()">Endless Mode (All Regions)</button>
    <button class="button" onclick="goToRegionSelect()">üåê Region Select</button>
  </div>

  <!-- Region Select Screen -->
  <div id="regionSelectScreen">
    <h2>üåç Select Region</h2>
    <button class="button" onclick="setRegion('all')">All Regions</button>
    <button class="button" onclick="setRegion('Africa')">Africa</button>
    <button class="button" onclick="setRegion('Americas')">Americas</button>
    <button class="button" onclick="setRegion('Asia')">Asia</button>
    <button class="button" onclick="setRegion('Europe')">Europe</button>
    <button class="button" onclick="setRegion('Oceania')">Oceania</button>
    <button class="button" onclick="goToMenu()">üîô Back</button>
  </div>

  <!-- Game Screen -->
  <div id="game">
    <div class="timer">Time Left: <span id="timer">10</span>s</div>
    <img id="flag" src="" alt="Flag" />
    <div id="options"></div>
    <p>Score: <span id="score">0</span></p>
  </div>

  <!-- Pause Screen -->
  <div id="pause">
    <h2>‚è∏Ô∏è Paused</h2>
    <button class="button" onclick="resumeGame()">Resume</button>
    <button class="button" onclick="goHome()">Home</button>
  </div>

  <!-- Wrong Answer Screen -->
  <div id="wrong">
    <h2>‚ùå Wrong!</h2>
    <p id="correctAnswerText"></p>
    <button class="button" onclick="goHome()">Continue</button>
  </div>

  <!-- Endless Results Screen -->
  <div id="endlessResults">
    <h2>üèÅ Game Over</h2>
    <p>Total Countries: <span id="totalCountries"></span></p>
    <p>Correct Answers: <span id="correctCount"></span></p>
    <p>Incorrect Answers: <span id="incorrectCount"></span></p>
    <p>Incorrect Countries:</p>
    <ul id="incorrectList"></ul>
    <button class="button" onclick="goHome()">Return Home</button>
  </div>

  <audio id="correctSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b23e97d0a4.mp3?filename=correct-answer-jingle-1-183909.mp3"></audio>
  <audio id="wrongSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_d73c7b3483.mp3?filename=error-2-180327.mp3"></audio>

  <script>
    let countries = [];
    let filteredCountries = [];
    let correctCountry = "";
    let score = 0;
    let highScores = JSON.parse(localStorage.getItem("flagHighScores") || "{}");
    let currentRegion = "all";

    let isEndlessMode = false;
    let unseenCountries = [];
    let correctAnswers = 0;
    let incorrectAnswers = 0;
    let incorrectCountries = [];

    /* ------------------------ NEW FUNCTION ------------------------ */
    function updateEndlessButtonLabel() {
      const label = currentRegion === "all" ? "All Regions" : currentRegion;
      document.getElementById("endlessButton").innerText = `Endless Mode (${label})`;
    }

    function updateHighScoreUI() {
      const highScore = highScores[currentRegion] || 0;
      document.getElementById("highScore").innerText = highScore;
      const label = currentRegion === "all" ? "All Regions" : currentRegion;
      document.getElementById("regionLabel").innerText = label;
    }

    async function fetchAllCountriesFromAPI() {
      try {
        const response = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2,region');
        const data = await response.json();
        return data.map(country => ({
          name: country.name.common,
          code: country.cca2,
          region: country.region,
          flag: `https://flagsapi.com/${country.cca2}/flat/256.png`
        }));
      } catch (error) {
        console.error('API error:', error);
        return [
          { name: "United States", code: "US", region: "Americas", flag: "https://flagsapi.com/US/flat/256.png" },
          { name: "Canada", code: "CA", region: "Americas", flag: "https://flagsapi.com/CA/flat/256.png" },
          { name: "France", code: "FR", region: "Europe", flag: "https://flagsapi.com/FR/flat/256.png" },
          { name: "Germany", code: "DE", region: "Europe", flag: "https://flagsapi.com/DE/flat/256.png" }
        ];
      }
    }

    async function fetchCountries() {
      countries = await fetchAllCountriesFromAPI();
      filterByRegion();
      document.getElementById('playButton').disabled = false;
      updateHighScoreUI();
      updateEndlessButtonLabel();
    }

    function filterByRegion() {
      filteredCountries = currentRegion === "all"
        ? [...countries]
        : countries.filter(c => c.region === currentRegion);

      const label = currentRegion === "all" ? "All Regions" : currentRegion;
      document.getElementById("playButton").innerText = `Play (${label})`;

      updateHighScoreUI();
      updateEndlessButtonLabel(); // <<< NEW FIX
    }

    function setRegion(region) {
      currentRegion = region;
      filterByRegion();
      updateEndlessButtonLabel(); // <<< NEW FIX
      goToMenu();
    }

    function goToRegionSelect() {
      document.getElementById("menu").style.display = "none";
      document.getElementById("regionSelectScreen").style.display = "block";
    }

    function goToMenu() {
      document.getElementById("regionSelectScreen").style.display = "none";
      document.getElementById("menu").style.display = "block";
      updateEndlessButtonLabel(); // <<< NEW FIX
    }

    function startGame() {
      isEndlessMode = false;
      document.getElementById("menu").style.display = "none";
      document.getElementById("game").style.display = "block";
      score = 0;
      document.getElementById("score").innerText = score;
      nextQuestion();
    }

    function startEndlessMode() {
      if (filteredCountries.length === 0) {
        alert("No countries available.");
        return;
      }
      isEndlessMode = true;
      unseenCountries = [...filteredCountries];
      shuffle(unseenCountries);
      correctAnswers = 0;
      incorrectAnswers = 0;
      incorrectCountries = [];
      score = 0;
      document.getElementById("score").innerText = score;
      document.getElementById("menu").style.display = "none";
      document.getElementById("game").style.display = "block";
      nextEndlessQuestion();
    }

    let timerInterval;
    let timeLeft = 10;

    function nextQuestion() {
      clearInterval(timerInterval);
      timeLeft = 10;
      document.getElementById("timer").innerText = timeLeft;

      const correct = filteredCountries[Math.floor(Math.random() * filteredCountries.length)];
      correctCountry = correct.name;
      setupQuestionUI(correct);
      startTimer();
    }

    function nextEndlessQuestion() {
      clearInterval(timerInterval);
      if (unseenCountries.length === 0) {
        showEndlessResults();
        return;
      }
      timeLeft = 10;
      document.getElementById("timer").innerText = timeLeft;

      const correct = unseenCountries.pop();
      correctCountry = correct.name;
      setupQuestionUI(correct);
      startTimer();
    }

    function setupQuestionUI(correct) {
      const flagImg = document.getElementById("flag");
      const primaryFlag = `https://flagcdn.com/w320/${correct.code.toLowerCase()}.png`;
      flagImg.src = primaryFlag;
      flagImg.alt = `Flag of ${correct.name}`;
      flagImg.onerror = () => {
        flagImg.src = correct.flag;
        flagImg.onerror = () => {
          flagImg.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='120'%3E%3Crect width='180' height='120' fill='%23e9ecef' stroke='%23dee2e6'/%3E%3Ctext x='90' y='60' text-anchor='middle' font-family='Arial' font-size='12' fill='%23495057'%3EFlag not available%3C/text%3E%3C/svg%3E";
        };
      };
      setupOptions(correct);
    }

    function setupOptions(correct) {
      let options = [correct.name];
      const others = filteredCountries
        .filter(c => c.name !== correct.name)
        .sort(() => 0.5 - Math.random())
        .slice(0, 3);

      options = options.concat(others.map(c => c.name));
      shuffle(options);
      const container = document.getElementById("options");
      container.innerHTML = "";
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "button";
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(opt);
        container.appendChild(btn);
      });
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").innerText = timeLeft;

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (isEndlessMode) {
            incorrectAnswers++;
            incorrectCountries.push(correctCountry);
            nextEndlessQuestion();
          } else {
            showWrong();
          }
        }
      }, 1000);
    }

    function checkAnswer(choice) {
      clearInterval(timerInterval);
      const isCorrect = choice === correctCountry;

      if (isEndlessMode) {
        if (isCorrect) {
          correctAnswers++;
          score++;
          document.getElementById("correctSound").play();
        } else {
          incorrectAnswers++;
          incorrectCountries.push(correctCountry);
          document.getElementById("wrongSound").play();
        }
        document.getElementById("score").innerText = score;
        nextEndlessQuestion();
      } else {
        if (isCorrect) {
          score++;
          document.getElementById("score").innerText = score;
          document.getElementById("correctSound").play();
          nextQuestion();
        } else {
          document.getElementById("wrongSound").play();
          showWrong();
        }
      }
    }

    function showWrong() {
      document.getElementById("game").style.display = "none";
      document.getElementById("wrong").style.display = "block";
      document.getElementById("correctAnswerText").innerText = "Correct answer was: " + correctCountry;

      if (!highScores[currentRegion] || score > highScores[currentRegion]) {
        highScores[currentRegion] = score;
        localStorage.setItem("flagHighScores", JSON.stringify(highScores));
      }
      updateHighScoreUI();
    }

    function showEndlessResults() {
      document.getElementById("game").style.display = "none";
      document.getElementById("endlessResults").style.display = "block";
      document.getElementById("totalCountries").innerText = correctAnswers + incorrectAnswers;
      document.getElementById("correctCount").innerText = correctAnswers;
      document.getElementById("incorrectCount").innerText = incorrectAnswers;

      const list = document.getElementById("incorrectList");
      list.innerHTML = "";
      incorrectCountries.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        list.appendChild(li);
      });
    }

    function pauseGame() {
      clearInterval(timerInterval);
      document.getElementById("game").style.display = "none";
      document.getElementById("pause").style.display = "block";
    }

    function resumeGame() {
      document.getElementById("pause").style.display = "none";
      document.getElementById("game").style.display = "block";
      startTimer();
    }

    function goHome() {
      clearInterval(timerInterval);
      isEndlessMode = false;
      document.getElementById("game").style.display = "none";
      document.getElementById("pause").style.display = "none";
      document.getElementById("wrong").style.display = "none";
      document.getElementById("endlessResults").style.display = "none";
      document.getElementById("menu").style.display = "block";
      updateHighScoreUI();
      updateEndlessButtonLabel();
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      document.getElementById("darkModeBtn").textContent =
        document.body.classList.contains("dark") ? "üåï" : "üåë";
    }

    fetchCountries();
  </script>
</body>
</html>
